<script setup lang="ts">
import { ref, type Ref } from 'vue';
import LoadingContainer from '@/base_components/ui/loaders/LoadingContainer.vue';
import { VulnerabilityPolicy } from '@/codeclarity_components/organizations/policy/vulnerability_policy.entity';
import { useUserStore } from '@/stores/user';
import { useAuthStore } from '@/stores/auth';
import type { PaginatedResponse } from '@/utils/api/responses/PaginatedResponse';
import PaginationComponent from '@/base_components/utilities/PaginationComponent.vue';
import { VulnerabilityPolicyRepository } from '@/codeclarity_components/organizations/policy/vulnerability_policy.repository';
import Badge from '@/shadcn/ui/badge/Badge.vue';
import { RouterLink } from 'vue-router';

const user = useUserStore();
const auth = useAuthStore();

const selected_vulnerability_policy = defineModel<string | null>('selected_vulnerability_policy', {
    default: null
});

const selected_vulnerability_policy_object = ref<VulnerabilityPolicy>();

const policyRepository: VulnerabilityPolicyRepository = new VulnerabilityPolicyRepository();

const vulnerability_policies_list: Ref<Array<VulnerabilityPolicy>> = ref([]);
const vulnerability_policies_list_loading_ref: Ref<typeof LoadingContainer | undefined> = ref();
const vulnerability_policies_list_loading_error: Ref<any> = ref(null);

const currentPage: Ref<number> = ref(0);
const defaultEntriesPerPage: Ref<number> = ref(3);
const totalPages: Ref<number> = ref(Math.ceil(vulnerability_policies_list.value.length / 10));

// Fetch vulnerability policies
async function fetchVulnerabilityPolicies() {
    if (auth.getAuthenticated && auth.getToken) {
        if (user.defaultOrg?.id === undefined) {
            return;
        }
        let res: PaginatedResponse<VulnerabilityPolicy>;
        try {
            res = await policyRepository.getVulnerabilityPolicies({
                orgId: user.defaultOrg?.id,
                page: 0,
                entries_per_page: 0,
                search_key: '',
                bearerToken: auth.getToken,
                handleBusinessErrors: true
            });
            vulnerability_policies_list.value = res.data;
            // Auto-select default policy if one exists
            const defaultPolicy = vulnerability_policies_list.value.find(
                (policy) => policy.default === true
            );
            if (defaultPolicy) {
                selected_vulnerability_policy_object.value = defaultPolicy;
                selected_vulnerability_policy.value = defaultPolicy.id;
            }
        } catch (err) {
            vulnerability_policies_list_loading_error.value = err;
            vulnerability_policies_list_loading_ref.value?.showError();
        } finally {
            vulnerability_policies_list_loading_ref.value?.showContent();
        }
    }
}

fetchVulnerabilityPolicies();
</script>
<template>
    <div>
        <div class="text-2xl font-medium mb-8">
            Select the vulnerability policy to use for the selected analyzers.
            <div class="text-sm text-gray-500 mt-1">
                Using a vulnerability policy you can tell our analyzers which vulnerabilities should
                be ignored or deprioritized during analysis. This helps you filter out false
                positives or vulnerabilities that are not applicable to your use case.
            </div>
        </div>
        <LoadingContainer ref="vulnerability_policies_list_loading_ref">
            <template #content>
                <div
                    v-if="vulnerability_policies_list.length > 0"
                    class="vulnerability-policies-list-wrapper"
                >
                    <!-- No Policy Option -->
                    <div
                        v-if="selected_vulnerability_policy_object == null"
                        class="vulnerability-policy vulnerability-policy-selected"
                    >
                        <div class="vulnerability-policy-header">
                            <div>
                                <div>
                                    No Policy
                                    <Badge class="ml-2">Selected</Badge>
                                </div>
                                <div class="text-muted-foreground text-base">
                                    Analysis will run without vulnerability filtering
                                </div>
                                <div class="text-muted-foreground text-base">
                                    All vulnerabilities will be reported without policy exclusions
                                </div>
                            </div>
                        </div>
                    </div>
                    <div
                        v-else
                        class="vulnerability-policy cursor-pointer"
                        @click="
                            selected_vulnerability_policy = null;
                            selected_vulnerability_policy_object = null;
                        "
                    >
                        <div class="vulnerability-policy-header">
                            <div>
                                <div>No Policy</div>
                                <div class="text-muted-foreground text-base">
                                    Analysis will run without vulnerability filtering
                                </div>
                                <div class="text-muted-foreground text-base">
                                    All vulnerabilities will be reported without policy exclusions
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        v-if="selected_vulnerability_policy_object != null"
                        class="vulnerability-policy vulnerability-policy-selected"
                    >
                        <div class="vulnerability-policy-header">
                            <div>
                                <div>
                                    {{ selected_vulnerability_policy_object.name }}
                                    <Badge class="ml-2">Selected</Badge>
                                    <Badge
                                        v-if="selected_vulnerability_policy_object.default == true"
                                        class="ml-2"
                                        >Default
                                    </Badge>
                                </div>
                                <div class="text-muted-foreground text-base">
                                    {{ selected_vulnerability_policy_object.description }}
                                </div>
                                <div class="text-muted-foreground text-base">
                                    Ignored vulnerabilities:
                                    <span>{{
                                        selected_vulnerability_policy_object.content.join(', ')
                                    }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div
                        v-for="vulnerability_policy in vulnerability_policies_list"
                        :key="vulnerability_policy.name"
                        @click="
                            selected_vulnerability_policy = vulnerability_policy.id;
                            selected_vulnerability_policy_object = vulnerability_policy;
                        "
                    >
                        <div
                            v-if="
                                vulnerability_policy.id != selected_vulnerability_policy_object?.id
                            "
                            class="vulnerability-policy cursor-pointer"
                        >
                            <div class="vulnerability-policy-header">
                                <div>
                                    <div>
                                        {{ vulnerability_policy.name }}
                                        <Badge
                                            v-if="vulnerability_policy.default == true"
                                            class="ml-2"
                                            >Default</Badge
                                        >
                                    </div>
                                    <div class="text-muted-foreground text-base">
                                        {{ vulnerability_policy.description }}
                                    </div>
                                    <div class="text-muted-foreground text-base">
                                        Ignored vulnerabilities:
                                        <span>{{ vulnerability_policy.content.join(', ') }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-gray-700 font-normal flex justify-between mt-10">
                        <PaginationComponent
                            v-model:page="currentPage"
                            v-model:nmb-entries-showing="defaultEntriesPerPage"
                            v-model:nmb-entries-total="vulnerability_policies_list.length"
                            v-model:total-pages="totalPages"
                        />
                    </div>
                </div>
                <div v-else class="vulnerability-policies-list-wrapper">
                    <!-- No Policy Option - shown when no policies exist -->
                    <div class="vulnerability-policy vulnerability-policy-selected">
                        <div class="vulnerability-policy-header">
                            <div>
                                <div>
                                    No Policy
                                    <Badge class="ml-2">Selected</Badge>
                                </div>
                                <div class="text-muted-foreground text-base">
                                    Analysis will run without vulnerability filtering
                                </div>
                                <div class="text-muted-foreground text-base">
                                    All vulnerabilities will be reported without policy exclusions
                                </div>
                            </div>
                        </div>
                    </div>

                    <div
                        class="font-semibold text-muted-foreground mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200"
                    >
                        <div class="text-blue-800">
                            ðŸ’¡ You have no vulnerability policies configured.
                        </div>
                        <div class="text-sm text-blue-700 mt-2">
                            You can create one
                            <RouterLink
                                :to="{
                                    name: 'orgs',
                                    params: {
                                        action: 'add',
                                        page: 'vulnerability-policy',
                                        orgId: user.defaultOrg?.id
                                    }
                                }"
                                class="text-blue-600 hover:text-blue-800 underline font-medium"
                            >
                                here
                            </RouterLink>
                            if you want to filter out specific vulnerabilities, but it's completely
                            optional.
                        </div>
                    </div>
                </div>
            </template>

            <template #error>
                {{ vulnerability_policies_list_loading_error }}
            </template>
        </LoadingContainer>
    </div>
</template>

<style scoped lang="scss">

.vulnerability-policies-list-wrapper {
    display: flex;
    flex-direction: column;
    row-gap: 10px;
}

.vulnerability-policy {
    border: 1px solid #dfdfdf;
    border-radius: 5px;
}

.vulnerability-policy-selected {
    border: 3px solid var(--color-accent);
}

.vulnerability-policy-header {
    padding: 15px;
    background-color: #fff;
    display: flex;
    flex-direction: row;
    justify-content: space-between;
    border-radius: 5px;
    position: relative;
}
</style>
