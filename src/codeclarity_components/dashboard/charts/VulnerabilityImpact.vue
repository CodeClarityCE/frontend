<script setup lang="ts">
import type {
  RadarChartData,
  RadarChartOptions,
} from "@/base_components/data-display/charts/radarChart";
import RadarChart from "@/base_components/data-display/charts/RadarChart.vue";
import BoxLoader from "@/base_components/ui/loaders/BoxLoader.vue";
import type { CIAImpact } from "@/codeclarity_components/dashboard/dashboard.entity";
import { DashboardRepository } from "@/codeclarity_components/dashboard/dashboard.repository";
import Button from "@/shadcn/ui/button/Button.vue";
import { useAuthStore } from "@/stores/auth";
import { useUserStore } from "@/stores/user";
import { BusinessLogicError } from "@/utils/api/BaseRepository";
import { Icon } from "@iconify/vue";
import { storeToRefs } from "pinia";
import { ref, watch, type Ref } from "vue";

// Props
const props = defineProps<{
  integrationIds: string[];
}>();

watch(props.integrationIds, async () => {
  void fetch();
});

// Repositories
const dashboardRepository: DashboardRepository = new DashboardRepository();

// Stores
const userStore = useUserStore();
const authStore = useAuthStore();

const { defaultOrg } = storeToRefs(userStore);

// State
const error: Ref<boolean> = ref(false);
const errorCode: Ref<string | undefined> = ref();
const loading: Ref<boolean> = ref(true);
const ciaMap: Ref<Record<string, { color: string; value: number }>> = ref({});

const chartData: Ref<RadarChartData> = ref([
  {
    name: "Mean Impact",
    axes: [],
  },
]);

const options: Ref<Partial<RadarChartOptions>> = ref({
  format: "0.1f",
  maxValue: 1.0,
});

async function fetch(refresh = false): Promise<void> {
  if (!defaultOrg?.value) return;
  if (!authStore.getAuthenticated || !authStore.getToken) return;

  if (!refresh) loading.value = true;

  ciaMap.value = {};
  error.value = false;
  errorCode.value = undefined;

  try {
    const resp = await dashboardRepository.getCIAImpact({
      orgId: defaultOrg.value.id,
      bearerToken: authStore.getToken,
      handleBusinessErrors: true,
      integrationIds: props.integrationIds,
    });
    void generateChart(resp.data);
  } catch (_err) {
    error.value = true;
    if (_err instanceof BusinessLogicError) {
      errorCode.value = _err.error_code;
    }
  } finally {
    if (!refresh) loading.value = false;
  }
}

function generateChart(stats: CIAImpact[]): void {
  const confidentiality = [];
  const integrity = [];
  const availability = [];
  for (const impact of stats) {
    if (impact.cia === "Confidentiality") {
      confidentiality.push(impact.impact);
    }
    if (impact.cia === "Integrity") {
      integrity.push(impact.impact);
    }
    if (impact.cia === "Availability") {
      availability.push(impact.impact);
    }
  }

  const firstChartData = chartData.value[0];
  if (firstChartData) {
    firstChartData.axes = [
      {
        axis: "CONFIDENTIALITY",
        value:
          confidentiality.reduce((a, b) => a + b, 0) / confidentiality.length,
      },
      {
        axis: "INTEGRITY",
        value: integrity.reduce((a, b) => a + b, 0) / integrity.length,
      },
      {
        axis: "AVAILABILITY",
        value: availability.reduce((a, b) => a + b, 0) / availability.length,
      },
    ];
  }
}

void fetch();
</script>
<template>
  <div class="p-6 pb-2">
    <div v-if="loading" class="flex flex-row gap-1">
      <div>
        <BoxLoader :dimensions="{ width: '250px', height: '250px' }" />
      </div>
    </div>
    <div v-else>
      <div v-if="error">
        <div class="flex flex-row gap-2">
          <Icon
            class="icon user-icon"
            icon="solar:confounded-square-outline"
            style="font-size: 3rem; height: fit-content"
          ></Icon>
          <div>
            <div class="flex flex-col gap-2">
              <div class="flex flex-col gap-2">
                <div>Failed to load the dashboard component</div>
              </div>
              <div class="flex flex-row gap-2 items-center flex-wrap">
                <Button @click="fetch()"> Try again </Button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div v-else class="flex flex-row justify-center items-center">
        <RadarChart
          :id="'ciaImpact'"
          :data="chartData"
          :options="options"
        ></RadarChart>
      </div>
    </div>
  </div>
</template>
