<script lang="ts" setup>
import {
    isMemberRoleGreaterOrEqualTo,
    MemberRole,
    type Organization
} from '@/codeclarity_components/organizations/organization.entity';
import HeaderItem from '@/codeclarity_components/organizations/subcomponents/HeaderItem.vue';
import router from '@/router';
import Alert from '@/shadcn/ui/alert/Alert.vue';
import AlertDescription from '@/shadcn/ui/alert/AlertDescription.vue';
import { Badge } from '@/shadcn/ui/badge';
import Button from '@/shadcn/ui/button/Button.vue';
import Checkbox from '@/shadcn/ui/checkbox/Checkbox.vue';
import { FormField } from '@/shadcn/ui/form';
import FormControl from '@/shadcn/ui/form/FormControl.vue';
import FormItem from '@/shadcn/ui/form/FormItem.vue';
import FormLabel from '@/shadcn/ui/form/FormLabel.vue';
import FormMessage from '@/shadcn/ui/form/FormMessage.vue';
import Input from '@/shadcn/ui/input/Input.vue';
import { useAuthStore } from '@/stores/auth';
import { useUserStore } from '@/stores/user';
import { BusinessLogicError } from '@/utils/api/BaseRepository';
import { filterUndefined } from '@/utils/form/filterUndefined';
import { Icon } from '@iconify/vue';
import { toTypedSchema } from '@vee-validate/zod';
import { storeToRefs } from 'pinia';
import { useForm } from 'vee-validate';
import { onBeforeMount, ref, type Ref, computed } from 'vue';
import { useRoute } from 'vue-router';
import { z } from 'zod';
import { VulnerabilityPolicyType } from '../vulnerability_policy.entity';
import { VulnerabilityPolicyRepository } from '../vulnerability_policy.repository';
import VulnerabilitySelector from './VulnerabilitySelector.vue';

const orgId: Ref<string> = ref('');
const orgInfo: Ref<Organization | undefined> = ref();

// Repository
const vulnerabilityPolicyRepository: VulnerabilityPolicyRepository =
    new VulnerabilityPolicyRepository();

// Store setup
const userStore = useUserStore();
const authStore = useAuthStore();

const { defaultOrg } = storeToRefs(userStore);

// Removed unused selectedVulnerabilities - vulnerabilities are managed in the form

const error: Ref<boolean> = ref(false);
const errorCode: Ref<string> = ref('');

// Form Validation
const formSchema = toTypedSchema(
    z.object({
        name: z
            .string()
            .min(5, 'Name must be at least 5 characters')
            .max(200, 'Name must be less than 200 characters'),
        description: z
            .string()
            .max(200, 'Description must be less than 200 characters')
            .optional()
            .default(''),
        isDefault: z.boolean().default(false),
        vulnerabilities: z.string().array().min(1, 'Please select at least one vulnerability')
    })
);

// Methods
const { handleSubmit, values } = useForm({
    validationSchema: formSchema,
    initialValues: {
        isDefault: false,
        name: '',
        description: '',
        vulnerabilities: []
    }
});

// Form validation computed property
const isFormValid = computed(() => {
    return (
        values.name &&
        values.name.length >= 5 &&
        values.vulnerabilities &&
        values.vulnerabilities.length > 0
    );
});

function setOrgInfo(_orgInfo: Organization): void {
    orgInfo.value = _orgInfo;
    if (!isMemberRoleGreaterOrEqualTo(_orgInfo.role, MemberRole.ADMIN)) {
        void router.push({ name: 'orgManage', params: { page: '', orgId: _orgInfo.id } });
    }
}

const onSubmit = handleSubmit(async (values) => {
    try {
        await vulnerabilityPolicyRepository.createPolicy({
            orgId: defaultOrg!.value!.id,
            data: {
                name: values.name,
                description: values.description ?? '',
                type: VulnerabilityPolicyType.BLACKLIST,
                vulnerabilities: values.vulnerabilities,
                default: values.isDefault
            },
            bearerToken: authStore.getToken ?? ''
        });
    } catch (_err) {
        error.value = true;
        if (_err instanceof BusinessLogicError) {
            errorCode.value = _err.error_code;
        }
    } finally {
        router.back();
    }
});

async function init(): Promise<void> {
    const route = useRoute();
    const _orgId = route.params.orgId;

    if (!_orgId) {
        router.back();
    }

    if (typeof _orgId === 'string') {
        orgId.value = _orgId;
    } else {
        router.back();
    }
}

onBeforeMount(async () => {
    await init();
});
</script>
<template>
    <div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
        <!-- Page Header -->
        <HeaderItem v-if="orgId" :org-id="orgId" @on-org-info="setOrgInfo($event)" />

        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Page Title -->
            <div class="mb-8">
                <div class="flex items-center gap-4 mb-4">
                    <div class="p-3 bg-gradient-to-r from-black to-gray-800 rounded-xl shadow-lg">
                        <Icon icon="solar:shield-bold" class="w-6 h-6 text-white" />
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">
                            Create Vulnerability Policy
                        </h1>
                        <p class="text-gray-600 mt-1">
                            Define a blacklist policy to exclude false positives from your security
                            analyses
                        </p>
                    </div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="bg-white rounded-2xl shadow-xl border border-gray-200/50 overflow-hidden">
                <div class="p-8">
                    <!-- Error Alert -->
                    <Alert v-if="error" variant="destructive" class="mb-8">
                        <AlertDescription class="flex flex-row gap-2 items-center">
                            <Icon icon="solar:danger-triangle-bold" class="text-red-500" />
                            <div v-if="errorCode" class="text-red-700">
                                We encountered an error while processing the request.
                            </div>
                            <div v-else class="text-red-700">
                                An error occurred during the processing of the request.
                            </div>
                        </AlertDescription>
                    </Alert>

                    <form class="space-y-8" @submit="onSubmit">
                        <!-- Policy Information Section -->
                        <div class="space-y-6">
                            <div class="border-b border-gray-200 pb-4">
                                <h2
                                    class="text-xl font-semibold text-gray-900 flex items-center gap-2"
                                >
                                    <Icon icon="solar:settings-bold" class="text-green-600" />
                                    Policy Configuration
                                </h2>
                                <p class="text-gray-600 mt-1">
                                    Define the basic settings for your vulnerability blacklist
                                    policy
                                </p>
                            </div>

                            <!-- Name Field -->
                            <FormField v-slot="{ componentField }" name="name">
                                <FormItem>
                                    <FormLabel class="text-sm font-medium text-gray-900">
                                        Policy Name <span class="text-green-600">*</span>
                                    </FormLabel>
                                    <FormControl>
                                        <Input
                                            placeholder="e.g., False Positives Policy, Development Environment Exclusions..."
                                            v-bind="filterUndefined(componentField)"
                                            class="mt-2 h-12 text-base border-gray-300 focus:border-green-500 focus:ring-green-500/20 rounded-lg"
                                        />
                                    </FormControl>
                                    <FormMessage class="mt-1" />
                                </FormItem>
                            </FormField>

                            <!-- Description Field -->
                            <FormField v-slot="{ componentField }" name="description">
                                <FormItem>
                                    <FormLabel class="text-sm font-medium text-gray-900">
                                        Description
                                    </FormLabel>
                                    <FormControl>
                                        <Input
                                            placeholder="Optional description explaining when and why this policy should be used..."
                                            v-bind="filterUndefined(componentField)"
                                            class="mt-2 h-12 text-base border-gray-300 focus:border-green-500 focus:ring-green-500/20 rounded-lg"
                                        />
                                    </FormControl>
                                    <FormMessage class="mt-1" />
                                </FormItem>
                            </FormField>

                            <!-- Default Policy Section -->
                            <FormField
                                v-slot="{ value, handleChange }"
                                type="checkbox"
                                name="isDefault"
                            >
                                <FormItem
                                    class="flex flex-row items-start space-x-4 space-y-0 p-4 border border-gray-200 rounded-lg bg-gray-50/50"
                                >
                                    <FormControl>
                                        <Checkbox
                                            :model-value="value"
                                            class="mt-1"
                                            @update:model-value="handleChange"
                                        />
                                    </FormControl>
                                    <div class="space-y-1">
                                        <FormLabel class="text-base font-medium text-gray-900">
                                            Set as default policy
                                        </FormLabel>
                                        <p class="text-sm text-gray-600">
                                            Automatically apply this policy to new security analyses
                                        </p>
                                    </div>
                                </FormItem>
                            </FormField>
                        </div>

                        <!-- Vulnerability Selection Section -->
                        <div class="space-y-6">
                            <div class="border-b border-gray-200 pb-4">
                                <h2
                                    class="text-xl font-semibold text-gray-900 flex items-center gap-2"
                                >
                                    <Icon icon="solar:shield-bold" class="text-green-600" />
                                    Vulnerability Selection
                                    <span class="text-green-600 text-base">*</span>
                                    <Badge
                                        v-if="values.vulnerabilities?.length"
                                        variant="secondary"
                                        class="ml-2"
                                    >
                                        {{ values.vulnerabilities.length }} selected
                                    </Badge>
                                </h2>
                                <p class="text-gray-600 mt-1">
                                    Choose which vulnerabilities to exclude from your security
                                    reports
                                </p>
                            </div>

                            <FormField
                                v-slot="{ setValue, value }"
                                type="checkbox"
                                name="vulnerabilities"
                            >
                                <FormItem>
                                    <FormControl>
                                        <div
                                            class="bg-gray-50/50 border border-gray-200 rounded-xl p-6"
                                        >
                                            <VulnerabilitySelector
                                                :model-value="value || []"
                                                placeholder="Search by CVE ID, aliases, or keywords to find vulnerabilities..."
                                                @update:model-value="setValue"
                                            />
                                        </div>
                                    </FormControl>
                                    <div
                                        v-if="(value || []).length > 0"
                                        class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg"
                                    >
                                        <div class="flex items-center gap-2 mb-2">
                                            <Icon
                                                icon="solar:info-circle-bold"
                                                class="text-blue-500"
                                            />
                                            <span class="text-sm font-medium text-blue-900"
                                                >Selection Summary</span
                                            >
                                        </div>
                                        <p class="text-sm text-blue-800">
                                            <strong>{{ (value || []).length }}</strong>
                                            vulnerability{{ (value || []).length !== 1 ? 's' : '' }}
                                            will be excluded from future analysis results.
                                        </p>
                                    </div>
                                    <FormMessage class="mt-2" />
                                </FormItem>
                            </FormField>
                        </div>

                        <!-- Submit Actions -->
                        <div class="pt-8 border-t border-gray-200">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-600">
                                    <Icon
                                        icon="solar:info-circle-bold"
                                        class="inline w-4 h-4 mr-1"
                                    />
                                    Fields marked with <span class="text-green-600">*</span> are
                                    required
                                </div>
                                <div class="flex items-center gap-3">
                                    <Button
                                        type="button"
                                        variant="outline"
                                        class="px-6 py-2.5"
                                        @click="$router.back()"
                                    >
                                        Cancel
                                    </Button>
                                    <Button
                                        type="submit"
                                        :disabled="!isFormValid"
                                        class="px-8 py-2.5 bg-gradient-to-r from-black to-gray-800 hover:from-gray-800 hover:to-gray-900 disabled:from-gray-400 disabled:to-gray-400 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2"
                                    >
                                        <Icon icon="solar:shield-bold" class="w-4 h-4" />
                                        Create Vulnerability Policy
                                    </Button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Info Panel -->
            <div class="mt-8 bg-green-50 border border-green-200 rounded-xl p-6">
                <div class="flex items-start gap-4">
                    <div class="p-2 bg-green-600 rounded-lg">
                        <Icon icon="solar:lightbulb-bold" class="w-5 h-5 text-white" />
                    </div>
                    <div>
                        <h3 class="font-semibold text-green-900 mb-2">
                            About Vulnerability Blacklist Policies
                        </h3>
                        <p class="text-green-800 text-sm mb-4">
                            These policies help you exclude false positives and irrelevant
                            vulnerabilities from your security reports, keeping your analysis
                            focused on actionable threats.
                        </p>
                        <ul class="space-y-2 text-sm text-green-700">
                            <li class="flex items-start gap-2">
                                <Icon
                                    icon="solar:check-circle-bold"
                                    class="w-4 h-4 mt-0.5 text-green-600 flex-shrink-0"
                                />
                                Only blacklist confirmed false positives or irrelevant findings
                            </li>
                            <li class="flex items-start gap-2">
                                <Icon
                                    icon="solar:check-circle-bold"
                                    class="w-4 h-4 mt-0.5 text-green-600 flex-shrink-0"
                                />
                                Use clear descriptions to document your decisions
                            </li>
                            <li class="flex items-start gap-2">
                                <Icon
                                    icon="solar:check-circle-bold"
                                    class="w-4 h-4 mt-0.5 text-green-600 flex-shrink-0"
                                />
                                Review and update your policies regularly
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
