<script lang="ts" setup>
import {
    isMemberRoleGreaterOrEqualTo,
    MemberRole,
    Organization
} from '@/codeclarity_components/organizations/organization.entity';
import router from '@/router';
import { onBeforeMount, ref, type Ref, computed } from 'vue';
import { useRoute } from 'vue-router';
import { useAuthStore } from '@/stores/auth';
import HeaderItem from '@/codeclarity_components/organizations/subcomponents/HeaderItem.vue';
import { useForm } from 'vee-validate';
import { VulnerabilityPolicyRepository } from '../vulnerability_policy.repository';
import type { VulnerabilityPolicy } from '../vulnerability_policy.entity';
import { BusinessLogicError } from '@/utils/api/BaseRepository';
import FormItem from '@/shadcn/ui/form/FormItem.vue';
import FormLabel from '@/shadcn/ui/form/FormLabel.vue';
import FormControl from '@/shadcn/ui/form/FormControl.vue';
import FormMessage from '@/shadcn/ui/form/FormMessage.vue';
import Input from '@/shadcn/ui/input/Input.vue';
import { FormField } from '@/shadcn/ui/form';
import Checkbox from '@/shadcn/ui/checkbox/Checkbox.vue';
import Button from '@/shadcn/ui/button/Button.vue';
import VulnerabilitySelector from './VulnerabilitySelector.vue';
import { toTypedSchema } from '@vee-validate/zod';
import { z } from 'zod';
import InfoCard from '@/base_components/ui/cards/InfoCard.vue';
import Alert from '@/shadcn/ui/alert/Alert.vue';
import AlertDescription from '@/shadcn/ui/alert/AlertDescription.vue';
import { Badge } from '@/shadcn/ui/badge';
import { Icon } from '@iconify/vue';
import LoadingComponent from '@/base_components/ui/loaders/LoadingComponent.vue';

const orgId: Ref<string> = ref('');
const policyId: Ref<string> = ref('');
const orgInfo: Ref<Organization | undefined> = ref();
const policy: Ref<VulnerabilityPolicy | null> = ref(null);

// Repository
const vulnerabilityPolicyRepository: VulnerabilityPolicyRepository =
    new VulnerabilityPolicyRepository();

// Store setup
const authStore = useAuthStore();

const loading: Ref<boolean> = ref(false);
const error: Ref<boolean> = ref(false);
const errorCode: Ref<string> = ref('');
const saving: Ref<boolean> = ref(false);

// Form Validation
const formSchema = toTypedSchema(
    z.object({
        name: z
            .string()
            .min(5, 'Name must be at least 5 characters')
            .max(200, 'Name must be less than 200 characters'),
        description: z
            .string()
            .max(200, 'Description must be less than 200 characters')
            .optional()
            .default(''),
        isDefault: z.boolean().default(false),
        vulnerabilities: z.string().array().min(1, 'Please select at least one vulnerability')
    })
);

// Methods
const { handleSubmit, values, setFieldValue } = useForm({
    validationSchema: formSchema,
    initialValues: {
        isDefault: false,
        name: '',
        description: '',
        vulnerabilities: []
    }
});

// Form validation computed property
const isFormValid = computed(() => {
    return (
        values.name &&
        values.name.length >= 5 &&
        values.vulnerabilities &&
        values.vulnerabilities.length > 0
    );
});

const hasChanges = computed(() => {
    if (!policy.value) return false;

    return (
        values.name !== policy.value.name ||
        values.description !== policy.value.description ||
        values.isDefault !== policy.value.default ||
        JSON.stringify([...(values.vulnerabilities || [])].sort()) !==
            JSON.stringify([...(policy.value.content || [])].sort())
    );
});

function setOrgInfo(_orgInfo: Organization) {
    orgInfo.value = _orgInfo;
    if (!isMemberRoleGreaterOrEqualTo(_orgInfo.role, MemberRole.ADMIN)) {
        router.push({ name: 'orgManage', params: { page: '', orgId: _orgInfo.id } });
    }
}

async function loadPolicy() {
    if (!authStore.getToken) return;

    loading.value = true;
    error.value = false;
    errorCode.value = '';

    try {
        const response = await vulnerabilityPolicyRepository.getPolicy({
            orgId: orgId.value,
            policyId: policyId.value,
            bearerToken: authStore.getToken
        });

        policy.value = response.data;

        // Populate form with existing data
        setFieldValue('name', policy.value.name);
        setFieldValue('description', policy.value.description || '');
        setFieldValue('isDefault', policy.value.default);
        setFieldValue('vulnerabilities', policy.value.content || []);
    } catch (_err) {
        error.value = true;
        if (_err instanceof BusinessLogicError) {
            errorCode.value = _err.error_code;
        }
        console.error('Error loading policy:', _err);
    } finally {
        loading.value = false;
    }
}

const onSubmit = handleSubmit(async (values) => {
    if (!hasChanges.value) {
        router.back();
        return;
    }

    saving.value = true;

    try {
        await vulnerabilityPolicyRepository.updatePolicy({
            orgId: orgId.value,
            policyId: policyId.value,
            data: {
                name: values.name,
                description: values.description ?? '',
                vulnerabilities: values.vulnerabilities,
                default: values.isDefault
            },
            bearerToken: authStore.getToken ?? ''
        });
    } catch (_err) {
        error.value = true;
        if (_err instanceof BusinessLogicError) {
            errorCode.value = _err.error_code;
        }
        console.error('Error updating policy:', _err);
    } finally {
        saving.value = false;
        router.back();
    }
});

async function init() {
    const route = useRoute();
    const _orgId = route.params.orgId;
    const _policyId = route.query.policyId as string; // Get from query instead of params

    if (!_orgId || !_policyId) {
        router.back();
        return;
    }

    if (typeof _orgId == 'string' && typeof _policyId == 'string') {
        orgId.value = _orgId;
        policyId.value = _policyId;
        await loadPolicy();
    } else {
        router.back();
    }
}

onBeforeMount(async () => {
    await init();
});
</script>
<template>
    <div class="min-h-screen bg-gray-50">
        <!-- Page Header -->
        <HeaderItem v-if="orgId" :org-id="orgId" @on-org-info="setOrgInfo($event)" />

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Loading State -->
            <div v-if="loading" class="flex items-center justify-center py-12">
                <div class="flex items-center gap-3 text-gray-500">
                    <LoadingComponent />
                    <span>Loading policy details...</span>
                </div>
            </div>

            <!-- Error State -->
            <div v-else-if="error && !policy" class="text-center py-12">
                <Icon
                    icon="solar:danger-triangle-bold"
                    class="w-16 h-16 text-red-300 mx-auto mb-4"
                />
                <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to load policy</h3>
                <p class="text-gray-500 mb-6">
                    {{
                        errorCode
                            ? 'We encountered an error while loading the policy.'
                            : 'An error occurred while loading the policy details.'
                    }}
                </p>
                <Button variant="outline" @click="$router.back()">
                    <Icon icon="solar:arrow-left-bold" class="w-4 h-4 mr-2" />
                    Go Back
                </Button>
            </div>

            <!-- Policy Edit Form -->
            <div v-else-if="policy">
                <!-- Page Header -->
                <InfoCard
                    title="Edit Vulnerability Policy"
                    :description="`Modify the blacklist policy '${policy.name}' to update excluded vulnerabilities`"
                    icon="solar:pen-bold"
                    variant="primary"
                    class="mb-8 shadow-lg"
                />

                <div class="grid lg:grid-cols-2 gap-8">
                    <!-- Left Column - Configuration Form -->
                    <InfoCard
                        title="Policy Configuration"
                        description="Update your vulnerability policy settings and selected vulnerabilities"
                        icon="solar:settings-bold"
                        variant="default"
                        class="shadow-md"
                    >
                        <Alert v-if="error && policy" variant="destructive" class="mb-6">
                            <AlertDescription class="flex flex-row gap-2 items-center">
                                <Icon icon="solar:danger-triangle-bold" class="text-red-500" />
                                <div v-if="errorCode" class="text-red-700">
                                    We encountered an error while updating the policy.
                                </div>
                                <div v-else class="text-red-700">
                                    An error occurred during the update process.
                                </div>
                            </AlertDescription>
                        </Alert>

                        <form class="space-y-8" @submit="onSubmit">
                            <!-- Basic Information Section -->
                            <div class="space-y-6">
                                <!-- Name Field -->
                                <FormField v-slot="{ componentField }" name="name">
                                    <FormItem>
                                        <FormLabel
                                            class="flex items-center gap-2 text-sm font-semibold text-gray-900 mb-2"
                                        >
                                            <Icon
                                                icon="solar:tag-bold"
                                                class="text-theme-primary"
                                            />
                                            Policy Name
                                            <span class="text-red-500">*</span>
                                        </FormLabel>
                                        <FormControl>
                                            <Input
                                                placeholder="Enter policy name..."
                                                v-bind="componentField"
                                                class="bg-white border-gray-300 focus:border-theme-primary focus:ring-theme-primary/20"
                                            />
                                        </FormControl>
                                        <FormMessage class="text-sm text-red-600 mt-1" />
                                    </FormItem>
                                </FormField>

                                <!-- Description Field -->
                                <FormField v-slot="{ componentField }" name="description">
                                    <FormItem>
                                        <FormLabel
                                            class="flex items-center gap-2 text-sm font-semibold text-gray-900 mb-2"
                                        >
                                            <Icon
                                                icon="solar:text-bold"
                                                class="text-theme-primary"
                                            />
                                            Description (Optional)
                                        </FormLabel>
                                        <FormControl>
                                            <Input
                                                placeholder="Enter a brief description of what this policy covers..."
                                                v-bind="componentField"
                                                class="bg-white border-gray-300 focus:border-theme-primary focus:ring-theme-primary/20"
                                            />
                                        </FormControl>
                                        <p class="text-xs text-gray-500 mt-1">
                                            Help your team understand the purpose of this policy
                                        </p>
                                        <FormMessage class="text-sm text-red-600 mt-1" />
                                    </FormItem>
                                </FormField>

                                <!-- Default Policy Section -->
                                <FormField
                                    v-slot="{ value, handleChange }"
                                    type="checkbox"
                                    name="isDefault"
                                >
                                    <FormItem
                                        class="flex flex-row items-start gap-x-4 space-y-0 rounded-lg border border-gray-200 bg-gray-50 p-4 hover:bg-gray-100 transition-colors duration-200"
                                    >
                                        <FormControl>
                                            <Checkbox
                                                :model-value="value"
                                                class="mt-1"
                                                @update:model-value="handleChange"
                                            />
                                        </FormControl>
                                        <div class="space-y-2 leading-none">
                                            <FormLabel
                                                class="flex items-center gap-2 text-base font-semibold text-gray-900"
                                            >
                                                <Icon
                                                    icon="solar:star-bold"
                                                    class="text-theme-primary"
                                                />
                                                Make this the default policy
                                            </FormLabel>
                                            <p class="text-sm text-gray-600">
                                                When enabled, this policy will be automatically
                                                applied to new analyses in your organization.
                                            </p>
                                            <FormMessage />
                                        </div>
                                    </FormItem>
                                </FormField>
                            </div>

                            <!-- Vulnerability Selection Section -->
                            <div class="border-t border-gray-100 pt-6">
                                <FormField
                                    v-slot="{ setValue, value }"
                                    type="checkbox"
                                    name="vulnerabilities"
                                >
                                    <FormItem>
                                        <FormLabel
                                            class="flex items-center gap-2 text-sm font-semibold text-gray-900 mb-4"
                                        >
                                            <Icon icon="solar:shield-bold" class="text-red-500" />
                                            Vulnerability Selection
                                            <span class="text-red-500">*</span>
                                            <Badge
                                                v-if="value?.length"
                                                variant="secondary"
                                                class="ml-2"
                                            >
                                                {{ value.length }} selected
                                            </Badge>
                                        </FormLabel>
                                        <FormControl>
                                            <div
                                                class="border border-gray-200 rounded-lg bg-white p-4"
                                            >
                                                <VulnerabilitySelector
                                                    :model-value="value || []"
                                                    placeholder="Search for vulnerabilities to blacklist (CVE IDs, aliases, or keywords)..."
                                                    @update:model-value="setValue"
                                                />
                                            </div>
                                        </FormControl>
                                        <div class="flex items-start gap-2 mt-2">
                                            <Icon
                                                icon="solar:info-circle-bold"
                                                class="text-red-500 mt-0.5 flex-shrink-0"
                                            />
                                            <p class="text-sm text-gray-500">
                                                Select vulnerabilities that should be excluded from
                                                analysis results because they are false positives or
                                                not relevant to your organization.
                                                <span class="font-medium"
                                                    >{{ (value || []).length }} vulnerabilities
                                                    currently selected.</span
                                                >
                                            </p>
                                        </div>
                                        <FormMessage class="text-sm text-red-600 mt-1" />
                                    </FormItem>
                                </FormField>
                            </div>

                            <!-- Submit Button Section -->
                            <div class="border-t border-gray-100 pt-6">
                                <div class="flex justify-end space-x-4">
                                    <Button
                                        type="button"
                                        variant="outline"
                                        class="px-6 py-3 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg transition-colors duration-200"
                                        :disabled="saving"
                                        @click="$router.back()"
                                    >
                                        Cancel
                                    </Button>
                                    <Button
                                        type="submit"
                                        :disabled="!isFormValid || !hasChanges || saving"
                                        class="px-8 py-3 bg-theme-black hover:bg-theme-gray disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center gap-2"
                                    >
                                        <Icon
                                            v-if="saving"
                                            icon="solar:refresh-bold"
                                            class="w-5 h-5 animate-spin"
                                        />
                                        <Icon v-else icon="solar:diskette-bold" class="w-5 h-5" />
                                        {{
                                            saving
                                                ? 'Saving...'
                                                : hasChanges
                                                  ? 'Update Policy'
                                                  : 'No Changes'
                                        }}
                                    </Button>
                                </div>
                            </div>
                        </form>
                    </InfoCard>

                    <!-- Right Column - Information -->
                    <div class="space-y-6">
                        <InfoCard
                            title="Policy Status"
                            description="Current policy information and status"
                            icon="solar:info-circle-bold"
                            variant="default"
                            class="shadow-md"
                        >
                            <div class="space-y-4">
                                <div
                                    class="flex items-center justify-between p-3 rounded-lg bg-gray-50"
                                >
                                    <div class="flex items-center gap-2">
                                        <Icon icon="solar:calendar-bold" class="text-blue-500" />
                                        <span class="text-sm font-medium">Created</span>
                                    </div>
                                    <span class="text-sm text-gray-600">
                                        {{ new Date(policy.created_on).toLocaleDateString() }}
                                    </span>
                                </div>

                                <div
                                    class="flex items-center justify-between p-3 rounded-lg bg-gray-50"
                                >
                                    <div class="flex items-center gap-2">
                                        <Icon icon="solar:user-bold" class="text-green-500" />
                                        <span class="text-sm font-medium">Created By</span>
                                    </div>
                                    <span class="text-sm text-gray-600">
                                        {{ policy.created_by || 'Unknown' }}
                                    </span>
                                </div>

                                <div
                                    class="flex items-center justify-between p-3 rounded-lg bg-gray-50"
                                >
                                    <div class="flex items-center gap-2">
                                        <Icon icon="solar:shield-bold" class="text-red-500" />
                                        <span class="text-sm font-medium">Vulnerabilities</span>
                                    </div>
                                    <span class="text-sm text-gray-600">
                                        {{ policy.content?.length || 0 }} excluded
                                    </span>
                                </div>

                                <div
                                    v-if="policy.default"
                                    class="flex items-center justify-between p-3 rounded-lg bg-blue-50 border border-blue-200"
                                >
                                    <div class="flex items-center gap-2">
                                        <Icon icon="solar:star-bold" class="text-blue-500" />
                                        <span class="text-sm font-medium">Default Policy</span>
                                    </div>
                                    <Badge variant="secondary" class="bg-blue-100 text-blue-800">
                                        Active
                                    </Badge>
                                </div>
                            </div>
                        </InfoCard>

                        <InfoCard
                            title="Change Summary"
                            description="Track your modifications to the policy"
                            icon="solar:history-bold"
                            variant="default"
                            class="shadow-md"
                        >
                            <div class="space-y-3">
                                <div
                                    class="flex items-center justify-between p-3 rounded-lg bg-gray-50"
                                >
                                    <div class="flex items-center gap-2">
                                        <Icon
                                            :icon="
                                                hasChanges
                                                    ? 'solar:check-circle-bold'
                                                    : 'solar:close-circle-bold'
                                            "
                                            :class="
                                                hasChanges ? 'text-orange-500' : 'text-gray-400'
                                            "
                                        />
                                        <span class="text-sm font-medium">Has Changes</span>
                                    </div>
                                    <span class="text-xs text-gray-500">
                                        {{ hasChanges ? 'Unsaved changes' : 'No changes' }}
                                    </span>
                                </div>

                                <div
                                    class="flex items-center justify-between p-3 rounded-lg bg-gray-50"
                                >
                                    <div class="flex items-center gap-2">
                                        <Icon
                                            :icon="
                                                isFormValid
                                                    ? 'solar:check-circle-bold'
                                                    : 'solar:close-circle-bold'
                                            "
                                            :class="
                                                isFormValid ? 'text-green-500' : 'text-gray-400'
                                            "
                                        />
                                        <span class="text-sm font-medium">Form Valid</span>
                                    </div>
                                    <span class="text-xs text-gray-500">
                                        {{
                                            isFormValid
                                                ? 'Ready to save'
                                                : 'Missing required fields'
                                        }}
                                    </span>
                                </div>
                            </div>
                        </InfoCard>

                        <InfoCard
                            title="Best Practices"
                            description="Tips for managing vulnerability policies"
                            icon="solar:lightbulb-bold"
                            variant="default"
                            class="shadow-md"
                        >
                            <div class="space-y-4">
                                <div class="flex items-start gap-3">
                                    <div
                                        class="flex-shrink-0 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center"
                                    >
                                        <Icon icon="solar:check-bold" class="text-white text-xs" />
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-gray-900 mb-1">
                                            Verify before updating
                                        </h5>
                                        <p class="text-sm text-gray-600">
                                            Ensure all changes are correct before saving
                                        </p>
                                    </div>
                                </div>
                                <div class="flex items-start gap-3">
                                    <div
                                        class="flex-shrink-0 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center"
                                    >
                                        <Icon icon="solar:check-bold" class="text-white text-xs" />
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-gray-900 mb-1">
                                            Monitor impact
                                        </h5>
                                        <p class="text-sm text-gray-600">
                                            Check how changes affect analysis results
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </InfoCard>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>
