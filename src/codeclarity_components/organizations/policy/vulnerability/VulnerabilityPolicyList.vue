<script lang="ts" setup>
import { ref, onBeforeMount, computed } from 'vue';
import type { Ref } from 'vue';
import { useRouter } from 'vue-router';
import { useAuthStore } from '@/stores/auth';
import { VulnerabilityPolicyRepository } from '../vulnerability_policy.repository';
import type { VulnerabilityPolicy } from '../vulnerability_policy.entity';
import { BusinessLogicError } from '@/utils/api/BaseRepository';
import { SortDirection } from '@/utils/api/PaginatedRequestOptions';
import VulnerabilityDataTable from './VulnerabilityDataTable.vue';
import { columns } from './columns';
import Button from '@/shadcn/ui/button/Button.vue';
import { Alert, AlertDescription } from '@/shadcn/ui/alert';
import { Icon } from '@iconify/vue';
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle
} from '@/shadcn/ui/dialog';

const props = defineProps<{
    page: string;
    orgId: string;
}>();

// Repository
const vulnerabilityPolicyRepository = new VulnerabilityPolicyRepository();
const router = useRouter();

// Store setup
const authStore = useAuthStore();

// Component state
const policies: Ref<VulnerabilityPolicy[]> = ref([]);
const loading: Ref<boolean> = ref(false);
const error: Ref<string> = ref('');
const selectedRows: Ref<string[]> = ref([]);

// Delete confirmation dialog
const deleteDialog: Ref<boolean> = ref(false);
const policyToDelete: Ref<VulnerabilityPolicy | null> = ref(null);
const deleting: Ref<boolean> = ref(false);

// Computed properties - For now we'll assume admin role since parent handles permissions
const canManagePolicies = computed(() => true);

const defaultPolicy = computed(() => {
    return policies.value.find((policy) => policy.default);
});

// Methods

async function loadPolicies() {
    if (!authStore.getToken) return;

    loading.value = true;
    error.value = '';

    try {
        const response = await vulnerabilityPolicyRepository.getPolicies({
            orgId: props.orgId,
            bearerToken: authStore.getToken,
            options: {
                page: 0,
                entriesPerPage: 100,
                activeFilters: [],
                sortBy: 'created_on',
                sortDirection: SortDirection.DESC,
                searchKey: ''
            }
        });

        // Response is a PaginatedResponse<VulnerabilityPolicy>
        policies.value = response.data || [];
    } catch (err) {
        console.error('Error loading vulnerability policies:', err);
        if (err instanceof BusinessLogicError) {
            error.value = err.error_message || 'Business logic error occurred';
        } else {
            error.value = 'Failed to load vulnerability policies. Please try again.';
        }
    } finally {
        loading.value = false;
    }
}

function navigateToCreate() {
    router.push({
        name: 'orgs',
        params: {
            action: 'add',
            page: 'vulnerability-policy',
            orgId: props.orgId
        }
    });
}

function handleEdit(policy: VulnerabilityPolicy) {
    router.push({
        name: 'orgs',
        params: {
            action: 'edit',
            page: 'vulnerability-policy',
            orgId: props.orgId
        },
        query: { policyId: policy.id }
    });
}

function handleDelete(policy: VulnerabilityPolicy) {
    policyToDelete.value = policy;
    deleteDialog.value = true;
}

async function confirmDelete() {
    if (!policyToDelete.value || !authStore.getToken) return;

    deleting.value = true;

    try {
        await vulnerabilityPolicyRepository.deletePolicy({
            orgId: props.orgId,
            policyId: policyToDelete.value.id,
            bearerToken: authStore.getToken
        });

        // Remove from local list
        policies.value = policies.value.filter((p) => p.id !== policyToDelete.value!.id);

        // Reset dialog state
        deleteDialog.value = false;
        policyToDelete.value = null;
    } catch (err) {
        console.error('Error deleting policy:', err);
        if (err instanceof BusinessLogicError) {
            error.value = err.error_message || 'Business logic error occurred';
        } else {
            error.value = 'Failed to delete policy. Please try again.';
        }
    } finally {
        deleting.value = false;
    }
}

function cancelDelete() {
    deleteDialog.value = false;
    policyToDelete.value = null;
}

onBeforeMount(async () => {
    await loadPolicies();
});
</script>

<template>
    <div id="vulnerability-policies-container" class="space-y-6">
        <!-- Header with Create Button -->
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="p-2 bg-gradient-to-r from-black to-gray-800 rounded-lg">
                    <Icon icon="solar:shield-bold" class="w-5 h-5 text-white" />
                </div>
                <div>
                    <h2 class="text-xl font-semibold text-gray-900">Vulnerability Policies</h2>
                    <p class="text-gray-600 text-sm">
                        Manage vulnerability blacklist policies to exclude false positives from
                        analysis results
                    </p>
                </div>
            </div>

            <Button
                v-if="canManagePolicies"
                class="bg-black hover:bg-gray-800 text-white font-medium px-4 py-2 rounded-lg shadow hover:shadow-md transition-all duration-200 flex items-center gap-2"
                @click="navigateToCreate"
            >
                <Icon icon="solar:add-circle-bold" class="w-4 h-4" />
                Create Policy
            </Button>
        </div>

        <!-- Error Alert -->
        <Alert v-if="error" variant="destructive">
            <Icon icon="solar:danger-triangle-bold" class="h-4 w-4" />
            <AlertDescription>{{ error }}</AlertDescription>
        </Alert>

        <!-- Default Policy Info -->
        <div
            v-if="defaultPolicy && !loading"
            class="bg-amber-50 border border-amber-200 rounded-lg p-4"
        >
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <Icon icon="solar:star-bold" class="w-5 h-5 text-amber-500" />
                    <div>
                        <h3 class="font-medium text-amber-900">{{ defaultPolicy.name }}</h3>
                        <p class="text-sm text-amber-700">
                            Default policy â€¢ Excludes
                            {{ defaultPolicy.content?.length || 0 }} vulnerability(s)
                        </p>
                    </div>
                </div>
                <Button
                    v-if="canManagePolicies"
                    variant="outline"
                    size="sm"
                    class="border-amber-200 text-amber-700 hover:bg-amber-100"
                    @click="handleEdit(defaultPolicy)"
                >
                    <Icon icon="solar:pen-bold" class="w-4 h-4 mr-1" />
                    Edit
                </Button>
            </div>
        </div>

        <!-- Loading State -->
        <div v-if="loading" class="flex items-center justify-center py-12">
            <div class="flex items-center gap-3 text-gray-500">
                <Icon icon="solar:refresh-bold" class="w-5 h-5 animate-spin" />
                <span>Loading vulnerability policies...</span>
            </div>
        </div>

        <!-- Policies Table -->
        <div v-else-if="policies.length > 0">
            <VulnerabilityDataTable
                :columns="columns"
                :data="policies"
                :on-edit="canManagePolicies ? handleEdit : undefined"
                :on-delete="canManagePolicies ? handleDelete : undefined"
                @update:row-selection="selectedRows = $event"
            />
        </div>

        <!-- Empty State -->
        <div v-else class="text-center py-16 bg-white border border-gray-200 rounded-lg">
            <Icon icon="solar:shield-bold" class="w-16 h-16 text-gray-300 mx-auto mb-4" />
            <h3 class="text-lg font-medium text-gray-900 mb-2">No vulnerability policies found</h3>
            <p class="text-gray-500 mb-6 max-w-md mx-auto">
                Create your first vulnerability policy to start excluding false positives and
                irrelevant vulnerabilities from your analysis results.
            </p>
            <Button
                v-if="canManagePolicies"
                class="bg-black hover:bg-gray-800 text-white font-medium px-6 py-2.5 rounded-lg shadow hover:shadow-md transition-all duration-200 flex items-center gap-2 mx-auto"
                @click="navigateToCreate"
            >
                <Icon icon="solar:add-circle-bold" class="w-4 h-4" />
                Create Your First Policy
            </Button>
        </div>

        <!-- Delete Confirmation Dialog -->
        <Dialog :open="deleteDialog" @update:open="deleteDialog = $event">
            <DialogContent class="sm:max-w-md">
                <DialogHeader>
                    <DialogTitle class="flex items-center gap-2">
                        <Icon
                            icon="solar:trash-bin-minimalistic-bold"
                            class="w-5 h-5 text-red-500"
                        />
                        Delete Vulnerability Policy
                    </DialogTitle>
                    <DialogDescription>
                        Are you sure you want to delete the policy "{{ policyToDelete?.name }}"?
                        This action cannot be undone.
                    </DialogDescription>
                </DialogHeader>

                <div v-if="policyToDelete" class="py-4">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <Icon
                                icon="solar:danger-triangle-bold"
                                class="w-5 h-5 text-red-500 mt-0.5"
                            />
                            <div>
                                <h4 class="font-medium text-red-800">
                                    This will affect
                                    {{ policyToDelete.content?.length || 0 }} vulnerability(s)
                                </h4>
                                <p class="text-sm text-red-600 mt-1">
                                    These vulnerabilities will no longer be excluded from analysis
                                    results.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <DialogFooter>
                    <Button variant="outline" :disabled="deleting" @click="cancelDelete">
                        Cancel
                    </Button>
                    <Button
                        variant="destructive"
                        :disabled="deleting"
                        class="flex items-center gap-2"
                        @click="confirmDelete"
                    >
                        <Icon
                            v-if="deleting"
                            icon="solar:refresh-bold"
                            class="w-4 h-4 animate-spin"
                        />
                        <Icon v-else icon="solar:trash-bin-minimalistic-bold" class="w-4 h-4" />
                        {{ deleting ? 'Deleting...' : 'Delete Policy' }}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    </div>
</template>
