<script lang="ts" setup>
import { ref, computed, watch } from 'vue';
import type { Ref } from 'vue';
import { Icon } from '@iconify/vue';
import { VulnerabilityPolicyRepository } from '../vulnerability_policy.repository';
import type { VulnerabilitySearchResult } from '../vulnerability_policy.entity';
import { useAuthStore } from '@/stores/auth';
import { BusinessLogicError } from '@/utils/api/BaseRepository';
import Input from '@/shadcn/ui/input/Input.vue';
import Button from '@/shadcn/ui/button/Button.vue';
import { Badge } from '@/shadcn/ui/badge';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/shadcn/ui/card';
import { Checkbox } from '@/shadcn/ui/checkbox';
import LoadingComponent from '@/base_components/ui/loaders/LoadingComponent.vue';
import { Alert, AlertDescription } from '@/shadcn/ui/alert';

interface Props {
    modelValue: string[];
    placeholder?: string;
    disabled?: boolean;
    maxSelections?: number;
}

interface Emits {
    (e: 'update:modelValue', value: string[]): void;
}

const props = withDefaults(defineProps<Props>(), {
    placeholder: 'Search for vulnerabilities (CVE IDs, aliases, or keywords)...',
    disabled: false,
    maxSelections: undefined
});

const emit = defineEmits<Emits>();

// Store setup
const authStore = useAuthStore();

// Repository
const vulnerabilityRepository = new VulnerabilityPolicyRepository();

// Component state
const searchQuery: Ref<string> = ref('');
const searchResults: Ref<VulnerabilitySearchResult[]> = ref([]);
const selectedVulns: Ref<string[]> = ref([...props.modelValue]);
const isLoading: Ref<boolean> = ref(false);
const error: Ref<string> = ref('');
const showResults: Ref<boolean> = ref(false);

// Debounced search
let searchTimeout: NodeJS.Timeout;

const isMaxSelectionsReached = computed(() => {
    return props.maxSelections !== undefined && selectedVulns.value.length >= props.maxSelections;
});

const filteredResults = computed(() => {
    return searchResults.value.filter((vuln) => !selectedVulns.value.includes(vuln.id));
});

const selectedVulnerabilityDetails = computed(() => {
    return selectedVulns.value.map((id) => {
        // Try to find details from previous search results or create basic info
        const found = searchResults.value.find((vuln) => vuln.id === id);
        return (
            found || {
                id,
                aliases: [id],
                description: '',
                severity: undefined,
                published_date: undefined,
                source: 'NVD' as const
            }
        );
    });
});

watch(searchQuery, (newQuery) => {
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    if (newQuery.trim().length < 2) {
        searchResults.value = [];
        showResults.value = false;
        return;
    }

    searchTimeout = setTimeout(() => {
        performSearch(newQuery.trim());
    }, 300);
});

watch(
    selectedVulns,
    (newValue) => {
        emit('update:modelValue', newValue);
    },
    { deep: true }
);

watch(
    () => props.modelValue,
    (newValue) => {
        selectedVulns.value = [...newValue];
    }
);

async function performSearch(query: string) {
    if (!authStore.getToken || query.length < 2) return;

    isLoading.value = true;
    error.value = '';

    try {
        const response = await vulnerabilityRepository.searchVulnerabilities({
            query,
            page: 0,
            limit: 20,
            bearerToken: authStore.getToken
        });

        searchResults.value = response.data || [];
        showResults.value = true;
    } catch (err) {
        console.error('Vulnerability search error:', err);
        if (err instanceof BusinessLogicError) {
            error.value = err.error_message || 'Business logic error occurred';
        } else {
            error.value = 'Failed to search vulnerabilities. Please try again.';
        }
        searchResults.value = [];
        showResults.value = false;
    } finally {
        isLoading.value = false;
    }
}

function toggleVulnerability(vulnId: string) {
    const index = selectedVulns.value.indexOf(vulnId);
    if (index > -1) {
        selectedVulns.value.splice(index, 1);
    } else if (!isMaxSelectionsReached.value) {
        selectedVulns.value.push(vulnId);
    }
}

function removeVulnerability(vulnId: string) {
    const index = selectedVulns.value.indexOf(vulnId);
    if (index > -1) {
        selectedVulns.value.splice(index, 1);
    }
}

function clearSelection() {
    selectedVulns.value = [];
}

function getSeverityColor(severity?: string): string {
    switch (severity?.toUpperCase()) {
        case 'CRITICAL':
            return 'text-red-800 bg-red-100 border-red-300';
        case 'HIGH':
            return 'text-orange-800 bg-orange-100 border-orange-300';
        case 'MEDIUM':
            return 'text-yellow-800 bg-yellow-100 border-yellow-300';
        case 'LOW':
            return 'text-blue-800 bg-blue-100 border-blue-300';
        case 'NONE':
            return 'text-gray-800 bg-gray-100 border-gray-300';
        default:
            return 'text-gray-600 bg-gray-50 border-gray-200';
    }
}
</script>

<template>
    <div class="space-y-4">
        <!-- Search Input -->
        <div class="relative">
            <div class="relative">
                <Icon
                    icon="solar:magnifer-bold"
                    class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"
                />
                <Input
                    v-model="searchQuery"
                    :placeholder="placeholder"
                    :disabled="disabled"
                    class="pl-10 pr-10"
                />
                <div v-if="isLoading" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                    <LoadingComponent size="sm" />
                </div>
            </div>

            <!-- Search Results Dropdown -->
            <div
                v-if="showResults && (filteredResults.length > 0 || searchQuery.length >= 2)"
                class="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-96 overflow-y-auto"
            >
                <div
                    v-if="filteredResults.length === 0 && !isLoading"
                    class="p-4 text-center text-gray-500"
                >
                    <Icon icon="solar:magnifer-bold" class="mx-auto mb-2 text-2xl" />
                    <p>No vulnerabilities found for "{{ searchQuery }}"</p>
                    <p class="text-sm text-gray-400 mt-1">Try searching with CVE IDs or keywords</p>
                </div>

                <div
                    v-for="vuln in filteredResults"
                    :key="vuln.id"
                    class="border-b border-gray-100 last:border-b-0"
                >
                    <div
                        class="p-3 hover:bg-gray-50 cursor-pointer flex items-start gap-3"
                        :class="{ 'opacity-50': isMaxSelectionsReached }"
                        @click="!isMaxSelectionsReached && toggleVulnerability(vuln.id)"
                    >
                        <Checkbox
                            :checked="selectedVulns.includes(vuln.id)"
                            :disabled="isMaxSelectionsReached && !selectedVulns.includes(vuln.id)"
                            class="mt-1"
                        />
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-medium text-gray-900">{{ vuln.id }}</span>
                                <Badge
                                    v-if="vuln.severity"
                                    :class="getSeverityColor(vuln.severity)"
                                    variant="outline"
                                >
                                    {{ vuln.severity }}
                                </Badge>
                                <!-- Show individual source if no multiple sources -->
                                <Badge v-if="!vuln.sources" variant="outline" class="text-xs">{{
                                    vuln.source
                                }}</Badge>
                                <!-- Show multiple sources indicator -->
                                <div v-else class="flex items-center gap-1">
                                    <Badge
                                        v-for="sourceInfo in vuln.sources"
                                        :key="sourceInfo.id"
                                        variant="outline"
                                        class="text-xs"
                                    >
                                        {{ sourceInfo.source }}
                                    </Badge>
                                    <span class="text-xs text-green-600 font-medium">
                                        ({{ vuln.sources.length }} sources)
                                    </span>
                                </div>
                            </div>

                            <div v-if="vuln.aliases && vuln.aliases.length > 1" class="mb-1">
                                <span class="text-xs text-gray-500">Aliases: </span>
                                <span class="text-xs text-gray-700">
                                    {{
                                        vuln.aliases
                                            .filter((alias: string) => alias !== vuln.id)
                                            .join(', ')
                                    }}
                                </span>
                            </div>

                            <p class="text-sm text-gray-600 line-clamp-2">{{ vuln.description }}</p>

                            <div v-if="vuln.published_date" class="text-xs text-gray-500 mt-1">
                                Published: {{ new Date(vuln.published_date).toLocaleDateString() }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Alert -->
        <Alert v-if="error" variant="destructive">
            <Icon icon="solar:danger-triangle-bold" class="h-4 w-4" />
            <AlertDescription>{{ error }}</AlertDescription>
        </Alert>

        <!-- Max Selections Warning -->
        <Alert v-if="isMaxSelectionsReached" variant="default">
            <Icon icon="solar:info-circle-bold" class="h-4 w-4" />
            <AlertDescription>
                Maximum of {{ maxSelections }} vulnerabilities can be selected.
            </AlertDescription>
        </Alert>

        <!-- Selected Vulnerabilities -->
        <div v-if="selectedVulns.length > 0">
            <Card>
                <CardHeader class="pb-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <CardTitle class="flex items-center gap-2 text-base">
                                <Icon icon="solar:shield-bold" class="text-red-500" />
                                Selected Vulnerabilities
                                <Badge variant="secondary">{{ selectedVulns.length }}</Badge>
                            </CardTitle>
                            <CardDescription>
                                These vulnerabilities will be included in the policy
                            </CardDescription>
                        </div>
                        <Button
                            variant="outline"
                            size="sm"
                            :disabled="disabled"
                            @click="clearSelection"
                        >
                            <Icon icon="solar:trash-bin-minimalistic-bold" class="mr-1" />
                            Clear All
                        </Button>
                    </div>
                </CardHeader>
                <CardContent>
                    <div class="space-y-2">
                        <div
                            v-for="vuln in selectedVulnerabilityDetails"
                            :key="vuln.id"
                            class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border"
                        >
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-medium text-gray-900">{{ vuln.id }}</span>
                                    <Badge
                                        v-if="vuln.severity"
                                        :class="getSeverityColor(vuln.severity)"
                                        variant="outline"
                                        class="text-xs"
                                    >
                                        {{ vuln.severity }}
                                    </Badge>
                                </div>

                                <p
                                    v-if="vuln.description"
                                    class="text-sm text-gray-600 line-clamp-1"
                                >
                                    {{ vuln.description }}
                                </p>

                                <div
                                    v-if="vuln.aliases && vuln.aliases.length > 1"
                                    class="text-xs text-gray-500 mt-1"
                                >
                                    Aliases:
                                    {{
                                        vuln.aliases
                                            .filter((alias: string) => alias !== vuln.id)
                                            .join(', ')
                                    }}
                                </div>
                            </div>

                            <Button
                                variant="ghost"
                                size="sm"
                                :disabled="disabled"
                                class="ml-2"
                                @click="removeVulnerability(vuln.id)"
                            >
                                <Icon icon="solar:close-circle-bold" class="text-red-500" />
                            </Button>
                        </div>
                    </div>
                </CardContent>
            </Card>
        </div>
    </div>
</template>

<style scoped>
.line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
