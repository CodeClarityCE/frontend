<script setup lang="ts">
import RadarChart from '@/base_components/data-display/charts/RadarChart.vue';
import type { VulnerabilityDetails } from '@/codeclarity_components/results/vulnerabilities/VulnDetails/VulnDetails';
import { Icon } from '@iconify/vue';
import { ref, type Ref } from 'vue';
import { getRadarChartData as getCVSSRadarChartConfig } from '../cvssChart';
import { getRadarChartData as getImpactRadarChartConfig } from '../impactChart';
// Chart.js imports removed - using d3 components

interface CVSSFieldConfig {
    full_name: string;
    values: string[];
    text: Record<string, unknown>;
    class: Record<string, string>;
    value_map: Record<string, string>;
}

const props = defineProps<{
    finding?: VulnerabilityDetails | null;
    cvssV3FieldsMap?: {
        [key: string]: CVSSFieldConfig;
        attack_vector: {
            full_name: string;
            values: string[];
            text: {
                description: string;
                value_descriptions: { P: string; L: string; A: string; N: string };
            };
            class: { P: string; L: string; A: string; N: string };
            value_map: { P: string; L: string; A: string; N: string };
        };
        attack_complexity: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { H: string; L: string } };
            class: { H: string; L: string };
            value_map: { H: string; L: string };
        };
        confidentiality_impact: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { H: string; L: string; N: string } };
            class: { N: string; L: string; H: string };
            value_map: { N: string; L: string; H: string };
        };
        integrity_impact: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { H: string; L: string; N: string } };
            class: { N: string; L: string; H: string };
            value_map: { N: string; L: string; H: string };
        };
        availability_impact: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { H: string; L: string; N: string } };
            class: { N: string; L: string; H: string };
            value_map: { N: string; L: string; H: string };
        };
        user_interaction: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { N: string; R: string } };
            class: { R: string; N: string };
            value_map: { R: string; N: string };
        };
        privileges_required: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { N: string; H: string; L: string } };
            class: { H: string; L: string; N: string };
            value_map: { H: string; L: string; N: string };
        };
        scope: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { U: string; C: string } };
            class: { U: string; C: string };
            value_map: { U: string; C: string };
        };
    };
    cvssV2FieldsMap?: {
        [key: string]: CVSSFieldConfig;
        access_vector: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { L: string; A: string; N: string } };
            class: { L: string; A: string; N: string };
            value_map: { L: string; A: string; N: string };
        };
        access_complexity: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { H: string; M: string; L: string } };
            class: { H: string; M: string; L: string };
            value_map: { H: string; M: string; L: string };
        };
        confidentiality_impact: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { N: string; P: string; C: string } };
            class: { N: string; P: string; C: string };
            value_map: { N: string; P: string; C: string };
        };
        integrity_impact: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { N: string; P: string; C: string } };
            class: { N: string; P: string; C: string };
            value_map: { N: string; P: string; C: string };
        };
        availability_impact: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { N: string; P: string; C: string } };
            class: { N: string; P: string; C: string };
            value_map: { N: string; P: string; C: string };
        };
        authentication: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { M: string; S: string; N: string } };
            class: { M: string; S: string; N: string };
            value_map: { M: string; S: string; N: string };
        };
        urser_interaction_required: {
            full_name: string;
            values: string[];
            text: { description: string; value_descriptions: { T: string; F: string } };
            class: { T: string; F: string };
            value_map: { T: string; F: string };
        };
    };
    chartVersion: string;
    cvssFieldInfoModalRef: {show: () => void};
}>();

const emit = defineEmits<(e: 'openModal', data: object) => void>();

const cvss_field: Ref<string> = ref('');
const cvss_field_value: Ref<string> = ref('');
const cvss_field_version: Ref<string> = ref('');
const cvss_info: Ref<object> = ref({});

function openCVSSFieldValueDetailsModal(
    _cvss_field: string,
    _cvss_field_value: string,
    _cvss_version: string
): void {
    cvss_field.value = _cvss_field;
    cvss_field_value.value = _cvss_field_value;
    cvss_field_version.value = _cvss_version;
    // props.cvss_field_info_modal_ref.show();
    if (cvss_field_version.value === '2') {
        cvss_info.value = props.cvssV2FieldsMap ?? {};
    }
    if (cvss_field_version.value === '3') {
        cvss_info.value = props.cvssV3FieldsMap ?? {};
    }
    emit('openModal', {
        cvss_field: cvss_field.value,
        cvss_field_value: cvss_field_value.value,
        cvss_field_version: cvss_field_version.value,
        cvss_info: cvss_info.value
    });
}
</script>

<template>
    <!--------------------------------------------------------------------------->
    <!--                            Severities Section                         -->
    <!--------------------------------------------------------------------------->
    <section class="bg-white shadow-md rounded-lg p-6">
        <h2 class="font-black text-xl text-gray-800">
            <span class="text-primary text-3xl">S</span>everities
        </h2>
        <div v-if="finding && finding.severities" class="cvss-details-wrapper flex flex-col gap-5">
            <!--------------------------------------------------------------------------->
            <!--                               CVSS 3.1 Info                           -->
            <!--------------------------------------------------------------------------->
            <div v-if="finding.severities.cvss_31" class="flex flex-col gap-2">
                <h3 class="font-black text-lg text-gray-700">CVSS 3.1</h3>
                <table class="cvss-table w-full border-collapse">
                    <tbody>
                        <tr>
                            <td class="font-medium text-gray-600">Score</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_31.base_score }}
                            </td>
                        </tr>
                        <tr>
                            <td class="font-medium text-gray-600">Exploitability</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_31.exploitability_score }}
                            </td>
                        </tr>
                        <tr>
                            <td class="font-medium text-gray-600">Impact</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_31.impact_score }}
                            </td>
                        </tr>
                        <tr
                            v-for="key in Object.keys(cvssV3FieldsMap || {})"
                            :key="key"
                            @click="
                                finding.severities.cvss_31[key] !== null &&
                                openCVSSFieldValueDetailsModal(
                                    key,
                                    finding.severities.cvss_31[key][0],
                                    '3'
                                )
                            "
                        >
                            <td>{{ props.cvssV3FieldsMap?.[key]?.full_name }}</td>
                            <td
                                v-if="finding.severities.cvss_31[key] !== null"
                                :class="
                                    props.cvssV3FieldsMap?.[key]?.class?.[
                                        finding.severities.cvss_31[key][0]
                                    ]
                                "
                            >
                                {{
                                    props.cvssV3FieldsMap?.[key]?.value_map?.[
                                        finding.severities.cvss_31[key][0]
                                    ]
                                }}
                            </td>
                            <td v-if="finding.severities.cvss_31[key] === null">No Data</td>
                        </tr>
                    </tbody>
                </table>
                <div class="flex items-center gap-2">
                    <Icon
                        :icon="'material-symbols:help-outline'"
                        style="scale: 0.9; color: rgb(85, 85, 85)"
                    ></Icon>
                    <span class="text-sm text-gray-500 italic">
                        Click on the CVSS fields to get more information.</span
                    >
                </div>
            </div>

            <!--------------------------------------------------------------------------->
            <!--                               CVSS3 Info                              -->
            <!--------------------------------------------------------------------------->
            <div v-if="finding.severities.cvss_3" class="flex flex-col gap-2">
                <h3 class="font-black text-lg text-gray-700">CVSS 3</h3>
                <table class="cvss-table w-full border-collapse">
                    <tbody>
                        <tr>
                            <td class="font-medium text-gray-600">Score</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_3.base_score }}
                            </td>
                        </tr>
                        <tr>
                            <td class="font-medium text-gray-600">Exploitability</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_3.exploitability_score }}
                            </td>
                        </tr>
                        <tr>
                            <td class="font-medium text-gray-600">Impact</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_3.impact_score }}
                            </td>
                        </tr>
                        <tr
                            v-for="key in Object.keys(cvssV3FieldsMap || {})"
                            :key="key"
                            @click="
                                finding.severities.cvss_3[key] !== null &&
                                openCVSSFieldValueDetailsModal(
                                    key,
                                    finding.severities.cvss_3[key][0],
                                    '3'
                                )
                            "
                        >
                            <td>{{ cvssV3FieldsMap?.[key]?.full_name }}</td>
                            <td
                                v-if="finding.severities.cvss_3[key] !== null"
                                :class="
                                    cvssV3FieldsMap?.[key]?.class?.[
                                        finding.severities.cvss_3[key][0]
                                    ]
                                "
                            >
                                {{
                                    cvssV3FieldsMap?.[key]?.value_map?.[
                                        finding.severities.cvss_3[key][0]
                                    ]
                                }}
                            </td>
                            <td v-if="finding.severities.cvss_3[key] === null">No Data</td>
                        </tr>
                    </tbody>
                </table>
                <div class="flex flex-row gap-2">
                    <Icon
                        :icon="'material-symbols:help-outline'"
                        style="scale: 0.9; color: rgb(85, 85, 85)"
                    ></Icon>
                    <span class="text-sm text-gray-500 italic">
                        Click on the CVSS fields to get more information.</span
                    >
                </div>
            </div>

            <!--------------------------------------------------------------------------->
            <!--                               CVSS2 Info                              -->
            <!--------------------------------------------------------------------------->
            <div v-if="finding.severities.cvss_2" class="flex flex-col gap-2">
                <h3 class="font-black text-lg text-gray-700">CVSS 2</h3>
                <table class="cvss-table w-full border-collapse">
                    <tbody>
                        <tr>
                            <td class="font-medium text-gray-600">Score</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_2.base_score }}
                            </td>
                        </tr>
                        <tr>
                            <td class="font-medium text-gray-600">Exploitability</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_2.exploitability_score }}
                            </td>
                        </tr>
                        <tr>
                            <td class="font-medium text-gray-600">Impact</td>
                            <td class="text-gray-800">
                                {{ finding.severities.cvss_2.impact_score }}
                            </td>
                        </tr>
                        <tr
                            v-for="key in Object.keys(cvssV2FieldsMap || {})"
                            :key="key"
                            @click="
                                finding.severities.cvss_2[key] !== null &&
                                openCVSSFieldValueDetailsModal(
                                    key,
                                    finding.severities.cvss_2[key][0],
                                    '2'
                                )
                            "
                        >
                            <td>{{ cvssV2FieldsMap?.[key]?.full_name }}</td>
                            <td
                                v-if="finding.severities.cvss_2[key] !== null"
                                :class="
                                    cvssV2FieldsMap?.[key]?.class?.[
                                        finding.severities.cvss_2[key][0]
                                    ]
                                "
                            >
                                {{
                                    cvssV2FieldsMap?.[key]?.value_map?.[
                                        finding.severities.cvss_2[key][0]
                                    ]
                                }}
                            </td>
                            <td v-if="finding.severities.cvss_2[key] === null">No Data</td>
                        </tr>
                    </tbody>
                </table>
                <div class="flex flex-row gap-2">
                    <Icon
                        :icon="'material-symbols:help-outline'"
                        style="scale: 0.9; color: rgb(85, 85, 85)"
                    ></Icon>
                    <span class="text-sm text-gray-500 italic">
                        Click on the CVSS fields to get more information.</span
                    >
                </div>
            </div>

            <!--------------------------------------------------------------------------->
            <!--                               CVSS Graph                              -->
            <!--------------------------------------------------------------------------->
            <div class="cvss-graph-wrapper">
                <div v-if="chartVersion === 'cvss31' && finding.severities.cvss_31">
                    <h3 class="font-black text-lg text-gray-700">CVSS 3.1 Graph</h3>
                    <div
                        style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            width: 450px;
                            height: 450px;
                        "
                    >
                        <RadarChart
                            id="cvss-31-radar-chart"
                            :data="getCVSSRadarChartConfig(finding) ?? []"
                            :options="{
                                w: 450,
                                h: 450,
                                margin: { top: 60, right: 60, bottom: 60, left: 60 },
                                levels: 5,
                                maxValue: 100,
                                labelFactor: 1.15,
                                wrapWidth: 40,
                                opacityArea: 0.35,
                                dotRadius: 3,
                                opacityCircles: 0.1,
                                strokeWidth: 2,
                                roundStrokes: false,
                                legend: false
                            }"
                        />
                    </div>
                </div>

                <div v-if="chartVersion === 'cvss3' && finding.severities.cvss_3">
                    <h3 class="font-black text-lg text-gray-700">CVSS3 Graph</h3>
                    <div
                        style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            width: 450px;
                            height: 450px;
                        "
                    >
                        <RadarChart
                            id="cvss-3-radar-chart"
                            :data="getCVSSRadarChartConfig(finding) ?? []"
                            :options="{
                                w: 450,
                                h: 450,
                                margin: { top: 60, right: 60, bottom: 60, left: 60 },
                                levels: 5,
                                maxValue: 100,
                                labelFactor: 1.15,
                                wrapWidth: 40,
                                opacityArea: 0.35,
                                dotRadius: 3,
                                opacityCircles: 0.1,
                                strokeWidth: 2,
                                roundStrokes: false,
                                legend: false
                            }"
                        />
                    </div>
                </div>

                <div v-if="chartVersion === 'cvss2' && finding.severities.cvss_2">
                    <h3 class="font-black text-lg text-gray-700">CVSS2 Graph</h3>
                    <div
                        style="
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            width: 450px;
                            height: 450px;
                        "
                    >
                        <RadarChart
                            id="cvss-2-radar-chart"
                            :data="getCVSSRadarChartConfig(finding) ?? []"
                            :options="{
                                w: 450,
                                h: 450,
                                margin: { top: 60, right: 60, bottom: 60, left: 60 },
                                levels: 5,
                                maxValue: 100,
                                labelFactor: 1.15,
                                wrapWidth: 40,
                                opacityArea: 0.35,
                                dotRadius: 3,
                                opacityCircles: 0.1,
                                strokeWidth: 2,
                                roundStrokes: false,
                                legend: false
                            }"
                        />
                    </div>
                </div>
            </div>

            <!--------------------------------------------------------------------------->
            <!--                             Impact Graph                              -->
            <!--------------------------------------------------------------------------->

            <div v-if="chartVersion === 'cvss31' && finding.severities.cvss_31">
                <h3 class="font-black text-lg text-gray-700">Impact</h3>
                <div
                    style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        width: 450px;
                        height: 450px;
                    "
                >
                    <RadarChart
                        id="cvss-31-impact-radar-chart"
                        :data="getImpactRadarChartConfig(finding) ?? []"
                        :options="{
                            w: 450,
                            h: 450,
                            margin: { top: 60, right: 60, bottom: 60, left: 60 },
                            levels: 5,
                            maxValue: 100,
                            labelFactor: 1.15,
                            wrapWidth: 40,
                            opacityArea: 0.35,
                            dotRadius: 3,
                            opacityCircles: 0.1,
                            strokeWidth: 2,
                            roundStrokes: false,
                            legend: false
                        }"
                    />
                </div>
            </div>

            <div v-else-if="chartVersion === 'cvss3' && finding.severities.cvss_3">
                <h3 class="font-black text-lg text-gray-700">Impact</h3>
                <div
                    style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        width: 450px;
                        height: 450px;
                    "
                >
                    <RadarChart
                        id="cvss-3-impact-radar-chart"
                        :data="getImpactRadarChartConfig(finding) ?? []"
                        :options="{
                            w: 450,
                            h: 450,
                            margin: { top: 60, right: 60, bottom: 60, left: 60 },
                            levels: 5,
                            maxValue: 100,
                            labelFactor: 1.15,
                            wrapWidth: 40,
                            opacityArea: 0.35,
                            dotRadius: 3,
                            opacityCircles: 0.1,
                            strokeWidth: 2,
                            roundStrokes: false,
                            legend: false
                        }"
                    />
                </div>
            </div>

            <div v-else-if="chartVersion === 'cvss2' && finding.severities.cvss_2">
                <h3 class="font-black text-lg text-gray-700">Impact</h3>
                <div
                    style="
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        width: 450px;
                        height: 450px;
                    "
                >
                    <RadarChart
                        id="cvss-2-impact-radar-chart"
                        :data="getImpactRadarChartConfig(finding) ?? []"
                        :options="{
                            w: 450,
                            h: 450,
                            margin: { top: 60, right: 60, bottom: 60, left: 60 },
                            levels: 5,
                            maxValue: 100,
                            labelFactor: 1.15,
                            wrapWidth: 40,
                            opacityArea: 0.35,
                            dotRadius: 3,
                            opacityCircles: 0.1,
                            strokeWidth: 2,
                            roundStrokes: false,
                            legend: false
                        }"
                    />
                </div>
            </div>
        </div>
        <div v-else class="p-4 text-gray-500">No vulnerability details available.</div>
    </section>
</template>

<style scoped lang="scss">
@use '@/assets/common/details.scss';
@use '@/assets/common/cvss.scss';
</style>
